---
title: "Model analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Packages + Functions
```{r setup, include=FALSE}
pacman::p_load(
  brms,
  #rethinking,
  tidyverse,
  bayesplot,
  #viridis,
  #dplyr,
  #data.table,
  ggplot2,
  BayesCombo,
  #beepr, #not in R version 4.0.2?
  patchwork,
  #modeest,
  renv,
  rlist,
  bayestestR
)
```

Reading data, adding important columns
```{r}
# Reading data
df <- read.csv("data/data_18_11_2020.csv")

# remove empty column
data$X1 <- NULL

# Summary statistics (could be used on website as priors if brms, but here we want it by the subsetted feature)
# mean(data$EffectSize)
# sd(data$EffectSize)
```

Possible features
```{r}
# Features with 3 or more disorders/MAs with 5 or more studies/rows (to be analysed) and their effect sizes
features <- data %>% 
  group_by(disorder, feature) %>% 
  summarise(
    n_studies = n(),
    .groups = "drop_last"
  ) %>% 
  filter(n_studies >= 5)

possible_features <- features %>% 
  group_by(feature) %>% 
  summarise(
    n_disorders = n(),
    disorders = list(disorder),
    .groups = "drop_last"
  ) %>% 
  filter(n_disorders >= 3)

# Which are these possible features?
possible_features$feature
# pause_duration, pitch, pitch_variability 

# Adding effect sizes (from website calculation)
# possible_features$es_c_asd <- c(0.00, NA, NA, 0.21, 0.38, 0.46, 0.86, NA, -0.10)
# possible_features$es_g_asd <- c(-0.01, NA, NA, 0.21, 0.37, 0.45, 0.84, NA, -0.10)
# possible_features$es_c_lhd <- c(NA, 0.68, 0.52, NA, NA, -0.41, NA, -1.44, NA)
# possible_features$es_g_lhd <- c(NA, 0.64, 0.50, NA, NA, -0.40, NA, -1.36, NA)
# possible_features$es_c_rhd <- c(-0.37, -3.00, -0.60, NA, 0.68, -0.34, 0.10, -1.67, NA)
# possible_features$es_g_rhd <- c(-0.35, -2.84, -0.57, NA, 0.64, -0.33, 0.09, -1.58, NA)
# possible_features$es_c_scz <- c(NA, 1.10, 1.78, 0.17, 0.16, -0.58, -0.15, NA, -0.87)
# possible_features$es_g_scz <- c(NA, 1.08, 1.72, 0.17, 0.15, -0.57, -0.15, NA, -0.86)
```

```{r}
# Subsetting (examples)
# pause_duration <- subset(data, feature == "pause_duration")
# pitch <- subset(data, feature == "pitch")
# pitch_var <- subset(data, feature == "pitch_variability")
```

Functions
```{r}
# subset for voice feature
feature_subset <- function(dataset, feature_name) {
  invisible(
    subset(dataset, feature == feature_name) %>%
    group_by(disorder) %>%
    filter(n() >= 5))
}

# run models (can be used for prior and real model)
brm_fit <- function(def_formula, data_subset, def_priors, sample_prior) {
  if (sample_prior == "only"){
    model <- brm(
      formula = def_formula,
      data = data_subset,
      family = student(),
      prior = def_priors,
      sample_prior = "only",
      seed = 28,
      chains = 4,
      cores = 6,
      iter = 4000,
      control = list(
        max_treedepth = 20,
        adapt_delta=0.98))
  }
  if (sample_prior == T) {
    model <- brm(
      formula = def_formula,
      data = data_subset,
      family = student(),
      prior = def_priors,
      sample_prior = T,
      seed = 28,
      chains = 4,
      cores = 6,
      iter = 4000,
      control = list(
        max_treedepth = 20,
        adapt_delta=0.98))
  }
  return(model)
}

# complete function
complete_brms <- function(data, feature, formula, priors, loo_criterion) {
  
  subset <- feature_subset(dataset = data, feature_name = feature) 
  
  # if ("native_language" %in% formula){
  #   # make languages with 1 into "Other"
  #   n_lang_df <- subset %>% group_by(native_language) %>% summarize(n_lang = n(), .groups = "drop_last")
  #   subset <- merge(subset, n_lang_df, by = "native_language")
  #   subset$native_language[subset$n_lang == 1] <- "Other"
  #   subset$dis_lang[subset$n_lang == 1] <- "Other"
  # }
  
  prior_model <- brm_fit(def_formula = formula, data_subset = subset, def_priors = priors, sample_prior = "only")
  
  posterior_model <- brm_fit(def_formula = formula, data_subset = subset, def_priors = priors, sample_prior = T)
  
  pp_checks <- pp_check(prior_model, nsamples = 1000) + pp_check(posterior_model, nsamples = 1000)
  
  summary <- summary(posterior_model)
  
  mcmc_trace <- mcmc_trace(posterior_model) + theme_classic()
  #mcmc_trace <- mcmc_trace(posterior_model, pars = c("^b_", "^sd_")) + theme_classic()
  
  mcmc_rank <- mcmc_rank_overlay(posterior_model) + theme_classic()
  #mcmc_rank <- mcmc_rank_overlay(posterior_model, pars = c("^b_", "^sd_")) + theme_classic()
  
  if(loo_criterion == T){
    posterior_model <- add_criterion(posterior_model, criterion = "loo", reloo = T, seed = TRUE)
  }
  
  return_objects <- list("data" = subset,
                         "feature" = feature,
                         "prior_model" = prior_model,
                         "posterior_model" = posterior_model,
                         "pp_checks" = pp_checks, 
                         "posterior_summary" = summary,
                         "mcmc_trace" = mcmc_trace, 
                         "mcmc_rank" = mcmc_rank
                         )
  return(return_objects)
}
```

Defining inputs to function
```{r}
# Formulas
f_disorder <- bf(g_calc|se(g_var_calc) ~ 0 + disorder + (1|gr(same_sample, by = disorder)) + (1|gr(study_disorder, by = disorder)) + (1|gr(expt_unique_dis, by = disorder)))

f_task <- bf(g_calc|se(g_var_calc) ~ 0 + disorder : task_type + (1|gr(same_sample, by = disorder)) + (1|gr(study_disorder, by = disorder)) + (1|gr(expt_unique_dis, by = dis_task)))

f_language <- bf(g_calc|se(g_var_calc) ~ 0 + disorder : native_language + (1|gr(same_sample, by = dis_lang)) + (1|gr(study_disorder, by = disorder)) + (1|gr(expt_unique_dis, by = dis_lang)))


# Priors
model_priors <- c(
  prior(normal(0, 2.5), class = b)
  #using default sd because we expect outliers
  )
```

Restoring the saved objects
```{r}
# Restore the saved object under a different name
# brm_pd_disorder <- readRDS("envr/brm_pd_disorder_2020_17_11.rds")
# brm_pd_task <- readRDS("envr/brm_pd_task_2020_17_11.rds")
# brm_pd_language <- readRDS("envr/brm_pd_language_2020_17_11.rds")
```

## ALL DATA
Running the three models, divided by feature
```{r}
# Pause duration
brm_pd_disorder <- complete_brms(data = df, feature = "pause_duration", formula = f_disorder, priors = model_priors, loo_criterion = F)
saveRDS(brm_pd_disorder, "envr/brm_pd_disorder_2020_18_11.rds")

brm_pd_task <- complete_brms(data = df, feature = "pause_duration", formula = f_task, priors = model_priors, loo_criterion = F)
saveRDS(brm_pd_task, "envr/brm_pd_task_2020_18_11.rds")

brm_pd_language <- complete_brms(data = df, feature = "pause_duration", formula = f_language, priors = model_priors, loo_criterion = F)
saveRDS(brm_pd_language, "envr/brm_pd_language_2020_18_11.rds")


# Pitch
brm_p_disorder <- complete_brms(data = df, feature = "pitch", formula = f_disorder, priors = model_priors, loo_criterion = F)
saveRDS(brm_p_disorder, "envr/brm_p_disorder_2020_18_11.rds")

brm_p_task <- complete_brms(data = df, feature = "pitch", formula = f_task, priors = model_priors, loo_criterion = F)
saveRDS(brm_p_task, "envr/brm_p_task_2020_20_11.rds")

brm_p_language <- complete_brms(data = df, feature = "pitch", formula = f_language, priors = model_priors, loo_criterion = F)
saveRDS(brm_p_language, "envr/brm_p_language_2020_18_11.rds")


# Pitch variability
brm_pv_disorder <- complete_brms(data = df, feature = "pitch_variability", formula = f_disorder, priors = model_priors, loo_criterion = F)
saveRDS(brm_pv_disorder, "envr/brm_pv_disorder_2020_18_11.rds")

brm_pv_task <- complete_brms(data = df, feature = "pitch_variability", formula = f_task, priors = model_priors, loo_criterion = F)
saveRDS(brm_pv_task, "envr/brm_pv_task_2020_18_11.rds")

brm_pv_language <- complete_brms(data = df, feature = "pitch_variability", formula = f_language, priors = model_priors, loo_criterion = F)
saveRDS(brm_pv_language, "envr/brm_pv_language_2020_18_11.rds")
```

# Quality checking
Pause duration
```{r}
# brm_pd_disorder (~ 0 + disorder)
brm_pd_disorder$posterior_summary #Rhat = 1.00, ESS > 2200
brm_pd_disorder$pp_checks

brm_pd_disorder$mcmc_trace
brm_pd_disorder$mcmc_rank

parnames(brm_pd_disorder$posterior_model)

plot(hypothesis(brm_pd_disorder$posterior_model,"disorderlhd = 0"))
plot(hypothesis(brm_pd_disorder$posterior_model,"disorderrhd = 0"))
plot(hypothesis(brm_pd_disorder$posterior_model,"disorderscz = 0"))

plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pd_disorder$posterior_model, "nu = 0", class = ""))


# brm_pd_task (~ 0 + disorder : task_type)
brm_pd_task$posterior_summary # Rhat = 1.00, ESS > 2200
brm_pd_task$pp_checks

brm_pd_task$mcmc_trace
brm_pd_task$mcmc_rank

parnames(brm_pd_task$posterior_model)

plot(hypothesis(brm_pd_task$posterior_model,"disorderlhd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pd_task$posterior_model,"disorderrhd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pd_task$posterior_model,"disorderscz:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pd_task$posterior_model,"disorderscz:task_typefreemonologicalproduction = 0"))
plot(hypothesis(brm_pd_task$posterior_model,"disorderscz:task_typesocialinteraction = 0"))

plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pd_task$posterior_model, "Intercept:dis_tasklhd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:dis_taskrhd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:dis_taskscz_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:dis_taskscz_freemonologicalproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_task$posterior_model, "Intercept:dis_taskscz_socialinteraction = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pd_task$posterior_model, "nu = 0", class = ""))



# brm_pd_language (~ 0 + disorder : native_language)
brm_pd_language$posterior_summary # Rhat = 1.00, ESS > 2400
brm_pd_language$pp_checks

brm_pd_language$mcmc_trace
brm_pd_language$mcmc_rank

parnames(brm_pd_language$posterior_model)

plot(hypothesis(brm_pd_language$posterior_model,"disorderlhd:native_languageEnglish = 0"))
plot(hypothesis(brm_pd_language$posterior_model,"disorderlhd:native_languageKorean = 0"))
plot(hypothesis(brm_pd_language$posterior_model,"disorderrhd:native_languageEnglish = 0"))
plot(hypothesis(brm_pd_language$posterior_model,"disorderrhd:native_languageKorean = 0"))
plot(hypothesis(brm_pd_language$posterior_model,"disorderscz:native_languageEnglish = 0"))
plot(hypothesis(brm_pd_language$posterior_model,"disorderscz:native_languageGerman = 0"))

plot(hypothesis(brm_pd_language$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langlhd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langlhd_Korean = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langrhd_Korean = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langscz_German = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langlhd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langlhd_Korean = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langrhd_Korean = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pd_language$posterior_model, "Intercept:dis_langscz_German = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pd_language$posterior_model, "nu = 0", class = ""))
```

Pitch
```{r}
# brm_p_disorder (~ 0 + disorder)
brm_p_disorder$posterior_summary # Rhat = 1.00, ESS > 1700
brm_p_disorder$pp_checks

brm_p_disorder$mcmc_trace
brm_p_disorder$mcmc_rank

parnames(brm_p_disorder$posterior_model)

plot(hypothesis(brm_p_disorder$posterior_model,"disorderasd = 0"))
plot(hypothesis(brm_p_disorder$posterior_model,"disorderrhd = 0"))
plot(hypothesis(brm_p_disorder$posterior_model,"disorderscz = 0"))

plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_p_disorder$posterior_model, "nu = 0", class = ""))


# brm_p_task (~ 0 + disorder : task_type)
brm_p_task$posterior_summary # Rhat = 1.00, ESS > 1500
brm_p_task$pp_checks

brm_p_task$mcmc_trace
brm_p_task$mcmc_rank

parnames(brm_p_task$posterior_model)

plot(hypothesis(brm_p_task$posterior_model,"disorderasd:task_typefreemonologicalproduction = 0"))
plot(hypothesis(brm_p_task$posterior_model,"disorderasd:task_typesocialinteraction = 0"))
plot(hypothesis(brm_p_task$posterior_model,"disorderrhd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_p_task$posterior_model,"disorderscz:task_typeconstrainedproduction = 0"))

plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_p_task$posterior_model, "Intercept:dis_taskasd_freemonologicalproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:dis_taskasd_socialinteraction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:dis_taskrhd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_task$posterior_model, "Intercept:dis_taskscz_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_p_task$posterior_model, "nu = 0", class = ""))


# brm_pd_language ()
brm_p_language$posterior_summary # Rhat = 1.00, ESS > 2100
brm_p_language$pp_checks

brm_p_language$mcmc_trace
brm_p_language$mcmc_rank

parnames(brm_p_language$posterior_model)

plot(hypothesis(brm_p_language$posterior_model,"disorderasd:native_languageDanish = 0"))
plot(hypothesis(brm_p_language$posterior_model,"disorderasd:native_languageEnglish = 0"))
plot(hypothesis(brm_p_language$posterior_model,"disorderasd:native_languagePortuguese = 0"))
plot(hypothesis(brm_p_language$posterior_model,"disorderrhd:native_languageEnglish = 0"))
plot(hypothesis(brm_p_language$posterior_model,"disorderscz:native_languageEnglish = 0"))

plot(hypothesis(brm_p_language$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_Danish = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_Portuguese = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_Danish = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langasd_Portuguese = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_p_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_p_language$posterior_model, "nu = 0", class = ""))
```

Pitch variability
```{r}
# brm_pv_disorder (~ 0 + disorder)
brm_pv_disorder$posterior_summary # Rhat = 1.00, ESS > 1500
brm_pv_disorder$pp_checks

brm_pv_disorder$mcmc_trace
brm_pv_disorder$mcmc_rank

parnames(brm_pv_disorder$posterior_model)

plot(hypothesis(brm_pv_disorder$posterior_model,"disorderasd = 0"))
plot(hypothesis(brm_pv_disorder$posterior_model,"disorderlhd = 0"))
plot(hypothesis(brm_pv_disorder$posterior_model,"disorderrhd = 0"))
plot(hypothesis(brm_pv_disorder$posterior_model,"disorderscz = 0"))

plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_disorder$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pv_disorder$posterior_model, "nu = 0", class = ""))


# brm_pv_task (~ 0 + disorder : task_type)
brm_pv_task$posterior_summary # Rhat = 1.00, ESS > 1100
brm_pv_task$pp_checks

brm_pv_task$mcmc_trace
brm_pv_task$mcmc_rank

parnames(brm_pv_task$posterior_model)

plot(hypothesis(brm_pv_task$posterior_model,"disorderasd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderasd:task_typefreemonologicalproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderasd:task_typesocialinteraction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderlhd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderrhd:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderrhd:task_typefreemonologicalproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderscz:task_typeconstrainedproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderscz:task_typefreemonologicalproduction = 0"))
plot(hypothesis(brm_pv_task$posterior_model,"disorderscz:task_typesocialinteraction = 0"))

plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskasd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskasd_freemonologicalproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskasd_socialinteraction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_tasklhd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskrhd_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskrhd_freemonologicalproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskscz_constrainedproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskscz_freemonologicalproduction = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_task$posterior_model, "Intercept:dis_taskscz_socialinteraction = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pv_task$posterior_model, "nu = 0", class = ""))


# brm_pv_language ()
brm_pv_language$posterior_summary # Rhat = 1.00, ESS > 1700
brm_pv_language$pp_checks

brm_pv_language$mcmc_trace
brm_pv_language$mcmc_rank

parnames(brm_pv_language$posterior_model)

plot(hypothesis(brm_pv_language$posterior_model,"disorderasd:native_languageDanish = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderasd:native_languageEnglish = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderasd:native_languageJapanese = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderasd:native_languagePortuguese = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderlhd:native_languageEnglish = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderlhd:native_languageKorean = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderrhd:native_languageEnglish = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderrhd:native_languageKorean = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderrhd:native_languagePolish = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderrhd:native_languageThai = 0"))
plot(hypothesis(brm_pv_language$posterior_model,"disorderscz:native_languageEnglish = 0"))

plot(hypothesis(brm_pv_language$posterior_model, "Intercept:disorderasd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:disorderlhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:disorderrhd = 0", class = "sd", group = "study_disorder"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:disorderscz = 0", class = "sd", group = "study_disorder"))

plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Danish = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Japanese = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Portuguese = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langlhd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langlhd_Korean = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Korean = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Polish = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Thai = 0", class = "sd", group = "same_sample"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "same_sample"))

plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Danish = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Japanese = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langasd_Portuguese = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langlhd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langlhd_Korean = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_English = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Korean = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Polish = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langrhd_Thai = 0", class = "sd", group = "expt_unique_dis"))
plot(hypothesis(brm_pv_language$posterior_model, "Intercept:dis_langscz_English = 0", class = "sd", group = "expt_unique_dis"))

plot(hypothesis(brm_pv_language$posterior_model, "nu = 0", class = ""))
```


Adding the loo criterion to all of the models above to see, where we have problematic observations, which cannot be refitted because of too little data (to be removed for the model comparison models)
```{r}
# Pause Duration
brm_pd_disorder$posterior_model <- add_criterion(brm_pd_disorder$posterior_model, criterion = "loo", reloo = T, seed = TRUE) #fine
brm_pd_task$posterior_model <- add_criterion(brm_pd_task$posterior_model, criterion = "loo", reloo = T, seed = TRUE) #fine
brm_pd_language$posterior_model <- add_criterion(brm_pd_language$posterior_model, criterion = "loo", reloo = T, seed = TRUE) #fine

# Pitch
brm_p_disorder$posterior_model <- add_criterion(brm_p_disorder$posterior_model, criterion = "loo", reloo = T, seed = TRUE) #fine
brm_p_task$posterior_model <- add_criterion(brm_p_task$posterior_model, criterion = "loo", reloo = T, seed = TRUE) # scz social interaction
brm_p_language$posterior_model <- add_criterion(brm_p_language$posterior_model, criterion = "loo", reloo = T, seed = TRUE) # SPANISH is a new level, not found

# Pitch variability
brm_pv_disorder$posterior_model <- add_criterion(brm_pv_disorder$posterior_model, criterion = "loo", reloo = T, seed = TRUE)
brm_pv_task$posterior_model <- add_criterion(brm_pv_task$posterior_model, criterion = "loo", reloo = T, seed = TRUE)
brm_pv_language$posterior_model <- add_criterion(brm_pv_language$posterior_model, criterion = "loo", reloo = T, seed = TRUE)
```


## REDUCED/EDITED DATA for model comparisons
Removing the data with problematic observations which could not be refitted because of lack of data
```{r}
# Pause Duration: No problem (reduced data is not needed)

# Pitch: Removing observations with n = 1 in dis_task or dis_lang
n_p_lang_df <- df %>% subset(feature == "pitch") %>% group_by(disorder, native_language) %>% summarize(n_lang = n(), .groups = "drop_last")
n_p_task_df <- df %>% subset(feature == "pitch") %>% group_by(disorder, task_type) %>% summarize(n_task = n(), .groups = "drop_last")

mc_p_df <- df %>% subset(feature == "pitch") %>%
  merge(., n_p_lang_df, by = c("disorder", "native_language")) %>%
  merge(., n_p_task_df, by = c("disorder", "task_type")) %>%
  subset(n_lang != 1) %>% 
  subset(n_task != 1)

# Pitch Variability: Removing observations with n = 1 in dis_task or dis_lang
n_pv_lang_df <- df %>% subset(feature == "pitch_variability") %>% group_by(disorder, native_language) %>% summarize(n_lang = n(), .groups = "drop_last")
n_pv_task_df <- df %>% subset(feature == "pitch_variability") %>% group_by(disorder, task_type) %>% summarize(n_task = n(), .groups = "drop_last")

mc_pv_df <- df %>% subset(feature == "pitch_variability") %>%
  merge(., n_pv_lang_df, by = c("disorder", "native_language")) %>%
  merge(., n_pv_task_df, by = c("disorder", "task_type")) %>%
  subset(n_lang != 1) %>% 
  subset(n_task != 1)
```

Running the three models for model comparison, divided by feature (reduced data)
```{r}
# Pause duration
# mc_pd_disorder <- complete_brms(data = df, feature = "pause_duration", formula = f_disorder, priors = model_priors, loo_criterion = T)
# saveRDS(mc_pd_disorder, "envr/mc_pd_disorder_2020_18_11.rds")
# 
# mc_pd_task <- complete_brms(data = df, feature = "pause_duration", formula = f_task, priors = model_priors, loo_criterion = T)
# saveRDS(mc_pd_task, "envr/mc_pd_task_2020_18_11.rds")
# 
# mc_pd_language <- complete_brms(data = df, feature = "pause_duration", formula = f_language, priors = model_priors, loo_criterion = T)
# saveRDS(mc_pd_language, "envr/mc_pd_language_2020_18_11.rds")


# Pitch
mc_p_disorder <- complete_brms(data = mc_p_df, feature = "pitch", formula = f_disorder, priors = model_priors, loo_criterion = T) #fine
saveRDS(mc_p_disorder, "envr/mc_p_disorder_2020_20_11.rds")

mc_p_task <- complete_brms(data = mc_p_df, feature = "pitch", formula = f_task, priors = model_priors, loo_criterion = T) #fine
saveRDS(mc_p_task, "envr/mc_p_task_2020_20_11.rds")

mc_p_language <- complete_brms(data = mc_p_df, feature = "pitch", formula = f_language, priors = model_priors, loo_criterion = T) #fine
saveRDS(mc_p_language, "envr/mc_p_language_2020_20_11.rds")


# Pitch variability
mc_pv_disorder <- complete_brms(data = mc_pv_df, feature = "pitch_variability", formula = f_disorder, priors = model_priors, loo_criterion = T) #fine
saveRDS(mc_pv_disorder, "envr/mc_pv_disorder_2020_20_11.rds")

mc_pv_task <- complete_brms(data = mc_pv_df, feature = "pitch_variability", formula = f_task, priors = model_priors, loo_criterion = T)
saveRDS(mc_pv_task, "envr/mc_pv_task_2020_20_11.rds")

mc_pv_language <- complete_brms(data = mc_pv_df, feature = "pitch_variability", formula = f_language, priors = model_priors, loo_criterion = T)
saveRDS(mc_pv_language, "envr/mc_pv_language_2020_20_11.rds")
```

# Model comparisons (both for pause duration, pitch, pitch variability)
```{r}
# Pause duration
loo_compare(brm_pd_disorder$posterior_model, brm_pd_task$posterior_model)
loo_compare(brm_pd_disorder$posterior_model, brm_pd_language$posterior_model)

loo_compare(brm_pd_disorder$posterior_model, brm_pd_task$posterior_model, brm_pd_language$posterior_model)

loo_model_weights(brm_pd_disorder$posterior_model, brm_pd_task$posterior_model)
loo_model_weights(brm_pd_disorder$posterior_model, brm_pd_language$posterior_model)

loo_model_weights(brm_pd_disorder$posterior_model, brm_pd_task$posterior_model, brm_pd_language$posterior_model)


# Pitch
loo_compare(mc_p_disorder$posterior_model, mc_p_task$posterior_model)
loo_compare(mc_p_disorder$posterior_model, mc_p_language$posterior_model)

loo_compare(mc_p_disorder$posterior_model, mc_p_task$posterior_model, mc_p_language$posterior_model)

loo_model_weights(mc_p_disorder$posterior_model, mc_p_task$posterior_model)
loo_model_weights(mc_p_disorder$posterior_model, mc_p_language$posterior_model)

loo_model_weights(mc_p_disorder$posterior_model, mc_p_task$posterior_model, mc_p_language$posterior_model)

# Pitch variability
loo_compare(mc_pv_disorder$posterior_model, mc_pv_task$posterior_model)
loo_compare(mc_pv_disorder$posterior_model, mc_pv_language$posterior_model)

loo_compare(mc_pv_disorder$posterior_model, mc_pv_task$posterior_model, mc_pv_language$posterior_model)

loo_model_weights(mc_pv_disorder$posterior_model, mc_pv_task$posterior_model)
loo_model_weights(mc_pv_disorder$posterior_model, mc_pv_language$posterior_model)

loo_model_weights(mc_pv_disorder$posterior_model, mc_pv_task$posterior_model, mc_pv_language$posterior_model)
```


# Hypothesis testing: ~ 0 + disorder
brm_pd_disorder, brm_p_disorder, brm_pv_disorder
```{r}
# brm_pd_disorder$data %>% group_by(disorder) %>% summarise(n = n())
# brm_p_disorder$data %>% group_by(disorder) %>% summarise(n = n())
# brm_pv_disorder$data %>% group_by(disorder) %>% summarise(n = n())

# Plots
conditional_effects(brm_pd_disorder$posterior_model, "disorder")
conditional_effects(brm_p_disorder$posterior_model, "disorder")
conditional_effects(brm_pv_disorder$posterior_model, "disorder")

# Pause duration
hypothesis(brm_pd_disorder$posterior_model,"disorderscz > disorderlhd") # ER = 
hypothesis(brm_pd_disorder$posterior_model,"disorderscz > disorderrhd") # ER = 
hypothesis(brm_pd_disorder$posterior_model,"disorderlhd > disorderrhd") # ER = 

#hypothesis(brm_pd_disorder$posterior_model,"disorderscz > 0") # ER =

# Pitch
hypothesis(brm_p_disorder$posterior_model,"disorderrhd > disorderasd") # ER = 
hypothesis(brm_p_disorder$posterior_model,"disorderrhd > disorderscz") # ER = 
hypothesis(brm_p_disorder$posterior_model,"disorderasd > disorderscz") # ER = 

# Pitch variability
hypothesis(brm_pv_disorder$posterior_model,"disorderasd > disorderrhd") # ER =
hypothesis(brm_pd_disorder$posterior_model,"disorderasd > disorderlhd") # ER =
hypothesis(brm_pd_disorder$posterior_model,"disorderasd > disorderscz") # ER =
hypothesis(brm_pd_disorder$posterior_model,"disorderrhd > disorderlhd") # ER =
hypothesis(brm_pd_disorder$posterior_model,"disorderrhd > disorderscz") # ER =
hypothesis(brm_pd_disorder$posterior_model,"disorderlhd > disorderscz") # ER =

#hypothesis(brm_pd_disorder$posterior_model,"disorderasd > 0") # ER =

# Remember: ASD = children, that might explain higher variability in pitch.
# Remember: ASD = might be more men/boys - at this age, do they still have a high pitch, or is that lower that women's?
```

# Hypothesis testing: ~ 0 + disorder : task
brm_pd_task, brm_p_task, brm_pv_task
```{r}
# brm_pd_disorder$data %>% group_by(disorder, task_type) %>% summarise(n = n())
# brm_p_disorder$data %>% group_by(disorder, task_type) %>% summarise(n = n())
# brm_pv_disorder$data %>% group_by(disorder, task_type) %>% summarise(n = n())

# Plots
conditional_effects(brm_pd_task$model, "disorder:task_type")
conditional_effects(brm_p_task$model, "disorder:task_type")
conditional_effects(brm_pv_task$model, "disorder:task_type")

# Pause Duration
hypothesis(brm_pd_task$posterior_model, "disorderlhd:task_typeconstrainedproduction > disorderrhd:task_typeconstrainedproduction") # ER =

# Pitch
# No comparisons to be made across disorders within task types

# Pitch Variability
hypothesis(brm_pv_task$posterior_model, "disorderasd:task_typefreemonologicalproduction > disorderscz:task_typefreemonologicalproduction") # ER =
hypothesis(brm_pv_task$posterior_model, "disorderrhd:task_typeconstrainedproduction > disorderlhd:task_typeconstrainedproduction") # ER =
```

# Hypothesis testing: ~ 0 + disorder : native_language
brm_pd_language, brm_p_language, brm_pv_language
```{r}
# brm_pd_disorder$data %>% group_by(disorder, native_language) %>% summarise(n = n())
# brm_p_disorder$data %>% group_by(disorder, native_language) %>% summarise(n = n())
# brm_pv_disorder$data %>% group_by(disorder, native_language) %>% summarise(n = n())

# Plots
conditional_effects(brm_pd_language$model, "disorder:native_language")
conditional_effects(brm_p_language$model, "disorder:native_language")
conditional_effects(brm_pv_language$model, "disorder:native_language")

# Pause Duration
hypothesis(brm_pd_lang$posterior_model, "disorderscz:native_languageEnglish > disorderrhd:native_languageEnglish") # ER = 

# Pitch
hypothesis(brm_p_lang$posterior_model, "disorderrhd:native_languageEnglish > disorderasd:native_languageEnglish") # ER = 

# Pitch Variability
hypothesis(brm_pv_lang$posterior_model, "disorderasd:native_languageEnglish > disorderrhd:native_languageEnglish") # ER = 
hypothesis(brm_pv_lang$posterior_model, "disorderasd:native_languageEnglish > disorderlhd:native_languageEnglish") # ER = 
hypothesis(brm_pv_lang$posterior_model, "disorderasd:native_languageEnglish > disorderscz:native_languageEnglish") # ER = 
hypothesis(brm_pv_lang$posterior_model, "disorderrhd:native_languageEnglish > disorderlhd:native_languageEnglish") # ER = 
hypothesis(brm_pv_lang$posterior_model, "disorderrhd:native_languageEnglish > disorderscz:native_languageEnglish") # ER = 
hypothesis(brm_pv_lang$posterior_model, "disorderlhd:native_languageEnglish > disorderscz:native_languageEnglish") # ER = 
```
